<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Attendance System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .video-container { position: relative; width: 100%; max-width: 320px; aspect-ratio: 4/3; background: #f3f4f6; border-radius: 8px; overflow: hidden; margin: 0 auto; }
    video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
    canvas { display: none; }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-6 space-y-6">
    <header class="text-center">
      <h1 class="text-2xl font-bold text-gray-800">Smart Attendance</h1>
      <p id="status-message" class="text-sm text-gray-600 mt-2"></p>
    </header>

    <div class="video-container">
      <video id="camera-feed" autoplay playsinline></video>
      <canvas id="photo-canvas"></canvas>
    </div>

    <div class="space-y-3">
      <input type="text" id="emp-id" placeholder="Enter Employee ID or Scan QR" class="w-full px-4 py-2 border rounded-lg">
      <input type="text" id="name" placeholder="Full Name" class="w-full px-4 py-2 border rounded-lg" readonly>
      <input type="text" id="department" placeholder="Department" class="w-full px-4 py-2 border rounded-lg" readonly>
      <input type="text" id="designation" placeholder="Designation" class="w-full px-4 py-2 border rounded-lg" readonly>
    </div>

    <div class="text-center">
      <a href="#" id="toggle-location-btn" class="text-blue-600 hover:underline text-sm">Working from Outside?</a>
    </div>

    <div id="location-options" class="hidden space-y-2 bg-gray-50 p-3 rounded-lg">
      <p class="text-sm font-medium text-gray-700">Select Location</p>
      <div class="flex items-center space-x-4">
        <label><input type="radio" name="location-type" value="Inside Office" checked> Inside Office</label>
        <label><input type="radio" name="location-type" value="Outside"> Outside</label>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <button id="in-btn" class="bg-green-500 text-white font-bold py-3 rounded-lg">IN</button>
      <button id="out-btn" class="bg-red-500 text-white font-bold py-3 rounded-lg">OUT</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script>
    const GAS_URL = 'YOUR_DEPLOYED_WEB_APP_URL'; // Replace with your deployed Apps Script URL
    const elements = {
      video: document.getElementById('camera-feed'),
      canvas: document.getElementById('photo-canvas'),
      empId: document.getElementById('emp-id'),
      name: document.getElementById('name'),
      department: document.getElementById('department'),
      designation: document.getElementById('designation'),
      inBtn: document.getElementById('in-btn'),
      outBtn: document.getElementById('out-btn'),
      statusMessage: document.getElementById('status-message'),
      toggleLocationBtn: document.getElementById('toggle-location-btn'),
      locationOptions: document.getElementById('location-options')
    };

    let stream;
    let employeeDatabase = {};
    let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');

    async function initCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } } });
        elements.video.srcObject = stream;
      } catch (error) {
        elements.statusMessage.textContent = 'Error: Cannot access camera.';
      }
    }

    function showStatus(message, type = 'info') {
      const colors = { info: 'text-blue-600', success: 'text-green-600', error: 'text-red-600', warning: 'text-yellow-600' };
      elements.statusMessage.className = colors[type] || colors.info;
      elements.statusMessage.textContent = message;
    }

    async function captureCompressedImage() {
      return new Promise((resolve) => {
        const context = elements.canvas.getContext('2d');
        const video = elements.video;
        const maxWidth = 640;
        const aspectRatio = video.videoWidth / video.videoHeight;
        elements.canvas.width = maxWidth;
        elements.canvas.height = maxWidth / aspectRatio;

        context.drawImage(video, 0, 0, elements.canvas.width, elements.canvas.height);

        const timestamp = new Date().toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' });
        context.font = '20px Inter';
        context.fillStyle = 'white';
        context.strokeStyle = 'black';
        context.lineWidth = 3;
        context.strokeText(timestamp, 20, elements.canvas.height - 20);
        context.fillText(timestamp, 20, elements.canvas.height - 20);

        const compressedDataUrl = elements.canvas.toDataURL('image/jpeg', 0.7);
        resolve(compressedDataUrl.split(',')[1]);
      });
    }

    async function markAttendance(status) {
      const empId = elements.empId.value.trim();
      if (!empId) {
        showStatus('Please enter Employee ID.', 'warning');
        return;
      }

      showStatus('Processing...', 'info');

      try {
        const imageData = await captureCompressedImage();
        const locationType = document.querySelector('input[name="location-type"]:checked').value;
        const payload = {
          id: 'att_' + Date.now(),
          empId,
          name: elements.name.value,
          department: elements.department.value,
          designation: elements.designation.value,
          status,
          locationType,
          imageData
        };

        if (!navigator.onLine) {
          saveOffline(payload);
          showStatus('Offline: Attendance saved locally.', 'warning');
          return;
        }

        await sendAttendance(payload);
      } catch (error) {
        showStatus('Error capturing image.', 'error');
      }
    }

    async function sendAttendance(payload) {
      try {
        const response = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
        const result = await response.json();
        if (result.status === 'success') {
          showStatus('Attendance marked successfully!', 'success');
        } else if (result.status === 'queued') {
          showStatus('High load. Attendance queued.', 'warning');
        } else {
          showStatus('Error: ' + result.message, 'error');
        }
      } catch (error) {
        saveOffline(payload);
        showStatus('Network error. Saved locally.', 'warning');
      }
    }

    function saveOffline(payload) {
      offlineQueue.push(payload);
      localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
    }

    async function syncOfflineData() {
      if (navigator.onLine && offlineQueue.length > 0) {
        showStatus('Syncing offline data...', 'info');
        const queueCopy = [...offlineQueue];
        offlineQueue = [];
        localStorage.setItem('offlineQueue', JSON.stringify([]));

        for (const item of queueCopy) {
          await sendAttendance(item);
        }
        showStatus('Offline data synced.', 'success');
      }
    }

    async function fetchEmployeeData() {
      try {
        const response = await fetch(GAS_URL + '?action=getEmployees');
        employeeDatabase = await response.json();
      } catch (error) {
        showStatus('Could not fetch employee data.', 'error');
      }
    }

    function handleIdInput() {
      const empId = elements.empId.value.trim().toUpperCase();
      if (!empId) return;
      const employee = employeeDatabase[empId];
      if (employee) {
        elements.name.value = employee.name;
        elements.department.value = employee.department;
        elements.designation.value = employee.designation;
      } else {
        elements.name.value = '';
        elements.department.value = '';
        elements.designation.value = '';
      }
    }

    elements.empId.addEventListener('blur', handleIdInput);
    elements.inBtn.addEventListener('click', () => markAttendance('IN'));
    elements.outBtn.addEventListener('click', () => markAttendance('OUT'));
    elements.toggleLocationBtn.addEventListener('click', (e) => { e.preventDefault(); elements.locationOptions.classList.toggle('hidden'); });

    window.addEventListener('online', syncOfflineData);

    initCamera();
    fetchEmployeeData();
    syncOfflineData();
  </script>
</body>
</html>
