<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance System</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for better readability -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .video-container { border: 10px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.1), 0 6px 20px rgba(0,0,0,0.1); border-radius: 8px; background: white; position: relative; overflow: hidden; }
        .btn-animate { transition: all 0.2s ease-in-out; }
        .btn-animate:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-animate:active { transform: translateY(0); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        input:read-only { background-color: #f3f4f6; cursor: not-allowed; }
        .btn-loader { border: 2px solid #f3f3f3; border-top: 2px solid #ffffff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-5">
        
        <header class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Smart Attendance</h1>
            <p class="text-gray-500">Mark your attendance</p>
        </header>

        <main id="app-content" class="space-y-4">
            <div class="video-container">
                <video id="camera-feed" autoplay playsinline class="w-full h-auto rounded-sm bg-gray-200"></video>
                <canvas id="photo-canvas" class="hidden"></canvas>
                <button id="switch-camera-btn" class="absolute bottom-2 right-2 bg-white/50 backdrop-blur-sm text-black text-xs font-semibold py-1 px-2 rounded-lg btn-animate hidden">Switch Camera</button>
            </div>
            
            <div class="space-y-3">
                <div>
                    <label for="emp-id" class="block text-sm font-medium text-gray-700 mb-1">Employee ID</label>
                    <input type="text" id="emp-id" placeholder="Loading data..." disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                 <!-- Location Type Toggle -->
                <div class="text-sm text-center">
                    <a href="#" id="toggle-location-btn" class="text-blue-600 hover:underline">Working from Outside?</a>
                </div>
                <!-- Location Options -->
                <div id="location-options-div" class="hidden space-y-2 rounded-lg bg-gray-50 p-3 transition-all duration-300">
                    <p class="text-sm font-medium text-gray-700">Select Location Type</p>
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center">
                            <input id="loc-inside" name="location-type" type="radio" value="Inside Office" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <label for="loc-inside" class="ml-2 block text-sm text-gray-900">Inside Office</label>
                        </div>
                        <div class="flex items-center">
                            <input id="loc-outside" name="location-type" type="radio" value="Outside" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                            <label for="loc-outside" class="ml-2 block text-sm text-gray-900">Outside</label>
                        </div>
                    </div>
                </div>
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="name" placeholder="Auto-filled" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                 <div>
                    <label for="department" class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                    <input type="text" id="department" placeholder="Auto-filled" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <button id="in-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg btn-animate flex justify-center items-center" disabled><span class="btn-text">IN</span></button>
                <button id="out-btn" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg btn-animate flex justify-center items-center" disabled><span class="btn-text">OUT</span></button>
            </div>

            <div id="status-message" class="text-center text-sm font-medium p-3 rounded-lg hidden"></div>
        </main>
        
        <footer class="text-center pt-4 border-t border-gray-200">
            <p class="text-xs text-gray-400">Developed by Amit Kumar</p>
        </footer>
    </div>

    <script>
        // --- Element References ---
        const video = document.getElementById('camera-feed'), canvas = document.getElementById('photo-canvas');
        const empIdInput = document.getElementById('emp-id'), nameInput = document.getElementById('name'), departmentInput = document.getElementById('department');
        const inBtn = document.getElementById('in-btn'), outBtn = document.getElementById('out-btn');
        const statusMessage = document.getElementById('status-message');
        const toggleLocationBtn = document.getElementById('toggle-location-btn');
        const locationOptionsDiv = document.getElementById('location-options-div');
        const switchCameraBtn = document.getElementById('switch-camera-btn');

        // ===================================================================================
        const GAS_URL = 'https://script.google.com/macros/s/AKfycby5ZQ_CsVJR7tPYB-qadfk_9ByChYEoIJcH5gALnYKFsbtYxqlV7z_TGBIADTNDafiF/exec';
        // ===================================================================================

        let employeeDatabase = {};
        let videoDevices = [];
        let currentDeviceIndex = 0;
        let currentStream;

        // --- Utility Functions ---
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = `text-center text-sm font-medium p-3 rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`;
            statusMessage.classList.remove('hidden');
        }

        function toggleButtonLoader(button, isLoading) {
            const buttonText = button.querySelector('.btn-text');
            if (isLoading) {
                button.disabled = true;
                buttonText.classList.add('hidden');
                const loader = document.createElement('div');
                loader.className = 'btn-loader';
                button.appendChild(loader);
            } else {
                button.disabled = false;
                buttonText.classList.remove('hidden');
                const loader = button.querySelector('.btn-loader');
                if (loader) loader.remove();
            }
        }

        // --- Main Initialization on Page Load ---
        window.addEventListener('load', async () => {
            initializeCamera();
            fetchEmployeeData();
        });

        // --- Camera Handling (FIXED) ---
        async function initializeCamera() {
            if (!navigator.mediaDevices?.getUserMedia) {
                showStatus('Error: Camera not supported.', true);
                return;
            }
            try {
                // Get list of all video cameras
                const devices = await navigator.mediaDevices.enumerateDevices();
                videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // Show switch button only if there are multiple cameras
                if (videoDevices.length > 1) {
                    switchCameraBtn.classList.remove('hidden');
                }
                
                // Start the camera stream
                await startStream();
            } catch (error) {
                showStatus('Error: Could not access camera.', true);
                console.error("Camera initialization error:", error);
            }
        }

        async function startStream() {
            // Stop any existing stream
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            // Set constraints for the selected camera
            const constraints = {
                video: { deviceId: videoDevices.length ? videoDevices[currentDeviceIndex].deviceId : undefined }
            };
            try {
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                video.onloadedmetadata = () => showStatus('Camera ready.', false);
            } catch (error) {
                showStatus('Error: Could not start camera.', true);
                console.error("Camera stream error:", error);
            }
        }

        async function switchCamera() {
            // Move to the next camera in the list
            currentDeviceIndex = (currentDeviceIndex + 1) % videoDevices.length;
            await startStream();
        }

        // --- Data and Business Logic ---
        async function fetchEmployeeData() {
            if (GAS_URL === 'PASTE_YOUR_COPIED_WEB_APP_URL_HERE') {
                showStatus("Configuration Error: Google Apps Script URL is missing.", true);
                empIdInput.placeholder = 'Config Error!'; return;
            }
            try {
                const response = await fetch(GAS_URL + "?action=getEmployees");
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                employeeDatabase = await response.json();
                empIdInput.disabled = false; empIdInput.placeholder = 'e.g., EMP001';
                inBtn.disabled = false; outBtn.disabled = false;
                showStatus('System Ready. Please enter your Employee ID.', false);
            } catch (error) {
                showStatus(`Error: Could not load data. ${error.message}`, true);
                empIdInput.placeholder = 'Loading failed';
            }
        }
        
        function handleIdInput() {
            const empId = empIdInput.value.trim().toUpperCase();
            if (!empId) return;
            const employee = employeeDatabase[empId];
            if (employee) {
                nameInput.value = employee.name;
                departmentInput.value = employee.department;
                showStatus('Employee found. Ready to mark attendance.', false);
            } else {
                nameInput.value = ''; departmentInput.value = '';
                showStatus('Employee ID not found.', true);
            }
        }

        async function markAttendance(status) {
            const empId = empIdInput.value.trim().toUpperCase();
            const name = nameInput.value.trim();
            if (!empId || !name) {
                showStatus('Please enter a valid Employee ID.', true); empIdInput.focus(); return;
            }
            const buttonToLoad = (status === 'IN') ? inBtn : outBtn;
            toggleButtonLoader(buttonToLoad, true);
            inBtn.disabled = true; outBtn.disabled = true;
            try {
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.9);
                const timestamp = new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
                const locationType = document.querySelector('input[name="location-type"]:checked').value;
                let locationData = { latitude: 'Not Available', longitude: 'Not Available' };
                try {
                    const position = await new Promise((resolve, reject) => { navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 }); });
                    locationData = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                } catch (geoError) { console.warn("Geolocation error:", geoError); }
                const dataToSend = { action: 'markAttendance', empId, name, locationType, imageData: imageData.split(',')[1], department: departmentInput.value, status, timestamp, latitude: locationData.latitude, longitude: locationData.longitude };
                const response = await fetch(GAS_URL, { method: 'POST', redirect: "follow", body: JSON.stringify(dataToSend), headers: { "Content-Type": "text/plain;charset=utf-8" } });
                const result = await response.json();
                if (result.status === 'success') {
                    showStatus(`Attendance marked as "${status}" successfully!`, false);
                    empIdInput.value = ''; nameInput.value = ''; departmentInput.value = '';
                } else { throw new Error(result.message || 'Unknown server error.'); }
            } catch (error) {
                console.error("Submission Error:", error);
                showStatus(`An error occurred: ${error.message}. Please try again.`, true);
            } finally {
                toggleButtonLoader(buttonToLoad, false);
                inBtn.disabled = false; outBtn.disabled = false;
            }
        }

        // --- Event Listeners ---
        inBtn.addEventListener('click', () => markAttendance('IN'));
        outBtn.addEventListener('click', () => markAttendance('OUT'));
        empIdInput.addEventListener('blur', handleIdInput);
        empIdInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleIdInput();
            }
        });
        toggleLocationBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const isHidden = locationOptionsDiv.classList.toggle('hidden');
            e.target.textContent = isHidden ? 'Working from Outside?' : 'Hide Location Options';
        });
        switchCameraBtn.addEventListener('click', switchCamera);

    </script>
</body>
</html>
